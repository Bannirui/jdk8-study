## 对象的实例化

---

### 创建对象的方式

* new关键字
* Class的newInstance(): 反射的方式 只能调用空参的构造器 权限必须是public
* Constructor的newInstance(): 反射的方式 可以调用空参、带参的构造方法 权限没有要求
* clone(): 不调用任何构造方法 当前类需要实现Cloneable接口 实现clone()方法
* 使用反序列化: 从文件中、网络中获取一个对象的二进制流
* 第三方库Objenesis

### 创建对象的步骤

* 判断对象对应的类是否加载、链接(检查、准备、解析)、初始化
* 为对象分配内存
  * 如果内存规整
    * 指针碰撞
  * 如果内存不规整
    * 虚拟机需要维护一个列表
    * 空闲列表分配
* 处理并发安全问题
  * 采用cas配上失败重试保证更新的原子性
  * 每个线程预先分配一个TLAB
* 初始化分配到的空间
* 设置对象的对象头
* 执行init方法进行初始化(属性的显式初始化、代码块中的初始化、构造方法的初始化)


### 对象内存布局

* 对象头Header(如果是数组，还需要记录数组的长度)
  * 运行时元数据Mark Word
    * 哈希值HashCode
    * GC分代年龄
    * 锁状态标志
    * 线程持有的锁
    * 偏向线程id
    * 偏向时间戳
  * 类型指针
    * 指向类元数据InstanceKlass 确定该对象的所属类型
* 实例数据Instance Data
  * 它是对象真正存储的有效信息，包括程序代码中定义的各种类型的字段(包括从父类继承下来的和本身拥有的字段)
  * 相同宽度的字段总是分配在一起
  * 父类中的变量会出现在子类之前
  * 如果CompactFields参数为true(默认为true)，子类的窄变量可能插入到父类变量的空隙
* 对齐填充Padding
  * 占位符作用
  
---

* 图解内存布局

![](./assets/对象实例化-1617203620922.png)

### 对象访问定位

* 对象访问方式
  * 句柄访问
  * 直接指针
